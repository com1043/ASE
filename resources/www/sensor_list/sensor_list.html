<!DOCTYPE html>
<html>
    <head>
        <script src="./manage_sensor_list.js"></script>
        <script type="module">
//통신모듈
import * as COMM from '/js/CommModule.js';
/*
function addItem(key, on) //table -> div 수정
{
	var state = on ? "checked" : "";
	var eItem = document.createElement("table");
	eItem.id = key;
	eItem.className = 'item';
	eItem.innerHTML = [
		'<tbody><tr><td class="title">',
		key,
		'</td>',
		'<td></td>',
		'<td>',
		'<label class="switch">',
		'<input id="',
		key + "stat",
		'" type="checkbox"',
		state,
		'>',
		'<div class="slider round"></div>',
		'</label>',
		'</td>',
		'<td>',
		// '<button class="item-btn" onclick="location.href=`sensor_info.html?`" action= "sensor_info.html" method = "get" id =',key, 'type="submit">VIEW</button>',
		'<button class="item-btn" onclick="location.href=`sensor_info.html?key=`"' + key + '">VIEW</button>',
		'</td>',
		'</tr></tbody>',
	].join("");
	document.getElementById('items')
		.append(eItem);
}
*/
// 서버로부터 데이터를 받은 모듈
var commModule = new COMM.CommModule(function()
{
	console.log("commModule load");
	console.log(commModule.sessionUUID);

},
function()
{//연결끊김
    document.getElementById("main").style.opacity = 0;
    document.getElementById("disconnected").style.opacity = 1;
},
function()
{//재연결
    document.getElementById("main").style.opacity = 1;
    document.getElementById("disconnected").style.opacity = 0;
});
window.onload = function()
{
	var sensorListCh = commModule.createChannel("SensorListRequest", null, (e) =>
	{
		console.log("data:" + e.data);
		var data = JSON.parse(e.data);
		console.log(data);
		console.log("count:" + data.count)
		for(var i in data.data) // 센서 수 만큼 반복문
		{
			addItem(data.data[i].id, data.data[i].on);
		}
		sensorListCh.close();
	});
	
	var allSensorOnOff = commModule.createChannel("RealtimeAllSensorOnOffRequest", null, (e) =>
	{
		console.log("data:" + e.data);
		var data = e.data.split("/");
		state(data[0], data[1] == "true");
	});

	var sensorAddRemove = commModule.createChannel("RealtimeSensorAddRemoveRequest", null, (e) =>
	{
		console.log(e.data);
		console.log("data:" + e.data);
		var data = e.data.split("/");
		if(data[1] == "true")
		{
			addItem(data[0], false);
		}
		else
		{
			delItem(key[0]);
		}
	});
}

        </script>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>MEERKEEP</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" href="image/logo_telco.png">
        <link type="text/css" rel="stylesheet" href="../css/style.css">
</head>
<body>
	<div>
		<header>
			<div>
				<img class="logo" src="image/logo_meerkeep.png" alt="">
				<div id="total" class="text1"></div>
			</div>
		</header>
		<section id="items" class="items">
		</section>
	</div>
	<div id="disconnected">
		<span>disconnected...</span>
	</div>
</body>
</html>
