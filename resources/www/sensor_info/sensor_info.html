<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>sensor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="image/logo_telco.png">
    <link type="text/css" rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <script src="./manage_sensor_info.js"></script>
    <script type="module">
                    //통신모듈
import * as COMM from '/js/CommModule.js';

// 서버로부터 데이터를 받은 모듈
var commModule = new COMM.CommModule(function()
{//최초연결
    console.log("commModule load");
    console.log(commModule.sessionUUID);

	
},
// 연결 끊김
function disconnect(){
    document.getElementById("main").style.opacity = 0.5;
    document.getElementById("disconnected").style.opacity = 1;
},
// 재접속
function reconnect(){
    document.getElementById("main").style.opacity = 1;
    document.getElementById("disconnected").style.opacity = 0;
});
window.onload = function()
{
    var sensorID = getParameter("key");
    dataSetKey(sensorID);

    // 이전데이터 띄우기
    var beforeSensorData = commModule.createChannel("AllSensorDataRequest", ()=>
    {
        var numbers = String(1);
        beforeSensorData.send(sensorID + "/" + numbers);
    }, (e) =>
    {
        var data = JSON.parse(e.data);
        if(data.result = true)
        {
            console.log(data);

        }
        else
        {
            beforeSensorData.close();
        }
    }
    );
    
	
    
    // 실시간 센서 데이터 요청
    var sensorData = commModule.createChannel("RealtimeSensorDataRequest",()=>
	{
		sensorData.send(sensorID);
	}, (e) =>
	{
		var data = JSON.parse(e.data);
		if(data.result == true)
		{
			console.log(Object.keys(data).length);
			if(Object.keys(data).length > 1)
			{
				var time = data.time.split("/");
				setSensorData(new Date(time[0], time[1], time[2], time[3], time[4], time[5]), data.xg, data.yg, data.xa, data.ya, data.za, data.al);
			}
		}
		else
		{
			sensorData.close();
		}
	});

    // 센서 전원 상태
    var sensorOnOff = commModule.createChannel("RealtimeSensorOnOffRequest",()=>
    {
		sensorOnOff.send(sensorID);
    }, (e)=>
    {
		var data = e.data.split("/");
		if(data[0] == "result" && data[1] != "true")
		{
			sensorOnOff.close();
		}
		else if(data[0] == "state")
		{
			setState(data[1] == "true");
		}
    });

    // log Bottom
    var sensorLog = commModule.createChannel("RealtimeSensorLog",()=>
    {
        sensorLog.send(sensorID);
    },(e) =>
    {
        var data = JSON.parse(e.data);
        if(data.result == true)
        {
            console.log("logData:" + data);
            console.log(object.key(data).length);
            if(object.key(data).length>1)
            {
                addLog(data.level, data.time, data.message);
            }
        }
        else
        {
            sensorLog.close();
        }

    });

    window.scrollTo(0,document.body.scrollHeight);
}
    </script>
    
</head>

<body>
    <div id="main" class="main">
        <section class="sensor">
            <header>
                <div>
                    <i class="fas fa-caret-square-left fa-2x back_btn" onclick="history.back(-1);"></i>
                    <div class="right_empty"></div>
                    <span class="text2"><span id="state_name" class="text2_name"></span><span id="state" class="info_on"></span></span>
                </div>
            </header>
            <div></div>
            <div class="state">
                <div>
                    <div class="state_item">기울기</div>
                    <div>
                        <span class="pos"> <span class="pos2">X</span> <span id="slopX"></span> <span class="unit">deg</span></span>
                        <span class="pos"> <span class="pos2">Y</span> <span id="slopY" ></span> <span class="unit">deg</span></span>
                    </div>
                </div>
                <div>
                    <div class="state_item">가속도</div>
                    <div>
                        <span class="pos"> <span class="pos2">X</span> <span id="accX"></span> <span class="unit">deg</span></span>
                        <span class="pos"> <span class="pos2">Y</span> <span id="accY"></span> <span class="unit">mG</span></span>
                        <span class="pos"> <span class="pos2">Z</span> <span id="accZ"></span> <span class="unit">mG</span></span>
                    </div>
                </div>
                <div>
                    <div class="state_item">고도</div>
                    <div>
                        <span class="pos"> <span class="pos2">A</span> <span id="alti"></span> <span class="unit">M</span></span>
                    </div>
                </div>
            </div>
            <div>
                <div>
                    <span class="uptime_title">데이터 수집 시간</span>
                </div>
                <div id="uptime" class="uptime"></div>
            </div>
            <div>
                <div class="title_log">센서 로그</div>
            </div>
        </section>
        <article>
            <div id="log" class="logs"></div>
        </article>
    </div>
    <div id="disconnected"  class="disconnected">
        <span>disconnected...</span>
    </div>
</body>

</html>